import { useState, useEffect } from 'react'
import './App.css'

function App() {
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedStyle, setSelectedStyle] = useState('')
  const [selectedInstrument, setSelectedInstrument] = useState('')
  const [results, setResults] = useState(null)
  const [loading, setLoading] = useState(false)
  const [activeTab, setActiveTab] = useState('title')
  const [showUploadModal, setShowUploadModal] = useState(false)
  const [uploadForm, setUploadForm] = useState({
    title: '',
    composer: '',
    instruments: '',
    style: '',
    opus: '',
    date_of_composition: '',
    source: '',
    pdf_file: null
  })
  const [uploadLoading, setUploadLoading] = useState(false)

  const styles = ['Baroque', 'Classical', 'Romantic', 'Renaissance', 'Modern', 'Jazz', 'Folk', 'Song']
  const instruments = ['Piano', 'Violin', 'Cello', 'Flute', 'Guitar', 'Voice', 'Clarinet', 'Saxophone']

  const handleSearch = async (query) => {
    if (!query) {
      return
    }

    setLoading(true)
    try {
      let endpoint
      if (activeTab === 'title') {
        endpoint = `/pieces/title/${query}`
      } else if (activeTab === 'style') {
        endpoint = `/pieces/styles/${query}`
      } else {
        endpoint = `/pieces/instruments/${query}`
      }
      const response = await fetch(endpoint)
      const data = await response.json()
      setResults(data)
    } catch (error) {
      console.error('Error fetching data:', error)
      setResults({ error: 'Failed to fetch results' })
    } finally {
      setLoading(false)
    }
  }

  // Search automatically when searchQuery changes (for title tab)
  useEffect(() => {
    if (activeTab === 'title') {
      const timeoutId = setTimeout(() => {
        handleSearch(searchQuery)
      }, 300)
      return () => clearTimeout(timeoutId)
    }
  }, [searchQuery, activeTab])

  // Search when selectedStyle changes (for style tab)
  useEffect(() => {
    if (activeTab === 'style' && selectedStyle) {
      handleSearch(selectedStyle)
    }
  }, [selectedStyle, activeTab])

  // Search when selectedInstrument changes (for instrument tab)
  useEffect(() => {
    if (activeTab === 'instrument' && selectedInstrument) {
      handleSearch(selectedInstrument)
    }
  }, [selectedInstrument, activeTab])

  return (
    <>
      <div>
      </div>
      <h1>Music Loader</h1>
      <div className="card">
        {/* Tab Navigation */}
        <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
          <button 
            onClick={() => setActiveTab('title')}
            style={{
              padding: '10px 20px',
              fontSize: '16px',
              borderRadius: '5px',
              border: activeTab === 'title' ? '2px solid #646cff' : '1px solid #ccc',
              backgroundColor: activeTab === 'title' ? '#646cff' : 'transparent',
              color: activeTab === 'title' ? 'white' : 'inherit',
              cursor: 'pointer'
            }}
          >
            Search by Title
          </button>
          <button 
            onClick={() => setActiveTab('style')}
            style={{
              padding: '10px 20px',
              fontSize: '16px',
              borderRadius: '5px',
              border: activeTab === 'style' ? '2px solid #646cff' : '1px solid #ccc',
              backgroundColor: activeTab === 'style' ? '#646cff' : 'transparent',
              color: activeTab === 'style' ? 'white' : 'inherit',
              cursor: 'pointer'
            }}
          >
            Search by Style
          </button>
          <button 
            onClick={() => setActiveTab('instrument')}
            style={{
              padding: '10px 20px',
              fontSize: '16px',
              borderRadius: '5px',
              border: activeTab === 'instrument' ? '2px solid #646cff' : '1px solid #ccc',
              backgroundColor: activeTab === 'instrument' ? '#646cff' : 'transparent',
              color: activeTab === 'instrument' ? 'white' : 'inherit',
              cursor: 'pointer'
            }}
          >
            Search by Instrument
          </button>
        </div>

        <h2>
          {activeTab === 'title' && 'Search by Title'}
          {activeTab === 'style' && 'Search by Style'}
          {activeTab === 'instrument' && 'Search by Instrument'}
        </h2>
        
        {activeTab === 'title' ? (
          <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
            <input
              type="text"
              placeholder="Search for music..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              style={{
                padding: '10px',
                fontSize: '16px',
                width: '300px',
                borderRadius: '5px',
                border: '1px solid #ccc'
              }}
            />
            {loading && <span>Searching...</span>}
          </div>
        ) : activeTab === 'style' ? (
          <div style={{ display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap' }}>
            <label style={{ fontWeight: 'bold' }}>Select a style:</label>
            {styles.map((style) => (
              <button
                key={style}
                onClick={() => setSelectedStyle(style)}
                style={{
                  padding: '8px 16px',
                  fontSize: '14px',
                  borderRadius: '5px',
                  border: selectedStyle === style ? '2px solid #646cff' : '1px solid #ccc',
                  backgroundColor: selectedStyle === style ? '#646cff' : 'transparent',
                  color: selectedStyle === style ? 'white' : 'inherit',
                  cursor: 'pointer'
                }}
              >
                {style}
              </button>
            ))}
          </div>
        ) : (
          <div style={{ display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap' }}>
            <label style={{ fontWeight: 'bold' }}>Select an instrument:</label>
            {instruments.map((instrument) => (
              <button
                key={instrument}
                onClick={() => setSelectedInstrument(instrument)}
                style={{
                  padding: '8px 16px',
                  fontSize: '14px',
                  borderRadius: '5px',
                  border: selectedInstrument === instrument ? '2px solid #646cff' : '1px solid #ccc',
                  backgroundColor: selectedInstrument === instrument ? '#646cff' : 'transparent',
                  color: selectedInstrument === instrument ? 'white' : 'inherit',
                  cursor: 'pointer'
                }}
              >
                {instrument}
              </button>
            ))}
          </div>
        )}
        {results && (
          <div style={{ marginTop: '20px', textAlign: 'left' }}>
            {results.error ? (
              <p style={{ color: 'red' }}>{results.error}</p>
            ) : (
              <>
                <h3>Found {results.length} pieces</h3>
                <div style={{ display: 'grid', gap: '15px' }}>
                  {results.map((piece) => (
                    <div 
                      key={piece._id} 
                      style={{ 
                        border: '1px solid #ddd', 
                        padding: '15px', 
                        borderRadius: '8px',
                        backgroundColor: '#000000ff',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'flex-start'
                      }}
                    >
                      <div style={{ flex: 1 }}>
                        <h4 style={{ margin: '0 0 10px 0' }}>Title: {piece.title}</h4>
                        <p><strong>Composer:</strong> {piece.composer}</p>
                        <p><strong>Style:</strong> {piece.style}</p>
                        <p><strong>Instruments:</strong> {piece.instruments}</p>
                        {piece.opus && <p><strong>Opus:</strong> {piece.opus}</p>}
                        <a 
                          href={piece.pdf_url} 
                          target="_blank" 
                          rel="noopener noreferrer"
                          style={{ 
                            display: 'inline-block',
                            padding: '8px 16px',
                            backgroundColor: '#646cff',
                            color: 'white',
                            textDecoration: 'none',
                            borderRadius: '5px',
                            fontWeight: 'bold',
                            marginTop: '10px',
                            transition: 'background-color 0.3s'
                          }}
                          onMouseEnter={(e) => e.target.style.backgroundColor = '#4f5acf'}
                          onMouseLeave={(e) => e.target.style.backgroundColor = '#646cff'}
                        >
                          ðŸ“„ View PDF
                        </a>
                      </div>
                      <img 
                        src="https://cdn.helloasso.com/images/header_public/badge-helloasso.svg" 
                        style={{
                          width: '100px',
                          height: 'auto',
                          flexShrink: 0,
                          marginLeft: '300px'
                        }} 
                      />
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        )}
      </div>
      
    </>
  )
}

export default App
